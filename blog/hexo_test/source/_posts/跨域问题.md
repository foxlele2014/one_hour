---
title: 跨域问题
date: 2018-02-07 17:01:20
tags:
- 跨域
category:
- javascript
---

- 原理
- 解决方法

### 概览（同源策略）
- 同源策略（Same-Origin Policy）：只有协议、主机、端口三者都相同才算同源（scheme://host:port）。
- 浏览器限制跨源的 DOM 读取与部分请求，防止恶意脚本窃取数据，但允许某些资源加载（图片、script、link 等）.

### 常见解决方法（简明）
1. CORS（推荐）
   - 通过服务器在响应头添加 Access-Control-Allow-* 系列允许跨域请求。
   - 简单请求：GET/POST（Content-Type 为简单类型）直接发送；复杂请求会触发预检（OPTIONS）。
   - 常用头：
     - Access-Control-Allow-Origin: https://example.com 或 *
     - Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS
     - Access-Control-Allow-Headers: X-Requested-With,Content-Type,Authorization
     - Access-Control-Allow-Credentials: true （若发送 cookie，不能与 * 一起使用）
   - Express 示例：
     ```javascript
     app.use((req, res, next) => {
       res.header('Access-Control-Allow-Origin', 'https://your.site');
       res.header('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS');
       res.header('Access-Control-Allow-Headers', 'Content-Type,Authorization');
       res.header('Access-Control-Allow-Credentials', 'true');
       if (req.method === 'OPTIONS') return res.sendStatus(204);
       next();
     });
     ```
2. JSONP（仅限 GET，老方法）
   - 通过 <script> 标签请求服务端返回一段调用回调的 JS。
   - 安全/功能受限，不支持 POST、Headers 等。
3. 代理（同源代理）
   - 前端请求同源的后端接口，后端转发到目标 API（常用于开发或绕过不支持 CORS 的第三方）。
   - Nginx 简单 proxy_pass 示例：
     ```
     location /api/ {
       proxy_pass https://api.example.com/;
     }
     ```
4. window.postMessage（跨窗口/iframe 通信）
   - 页面与 iframe、子窗口之间安全传递消息，需校验 origin。
   - 使用场景：跨域 iframe 通信、OAuth 回调等。
   ```javascript
   // 发送
   otherWindow.postMessage({ type:'ok' }, 'https://target.com');
   // 接收
   window.addEventListener('message', e => {
     if (e.origin !== 'https://target.com') return;
     // 处理 e.data
   });
   ```
5. document.domain（仅限二级域名相同的场景，逐步废弃/风险）
6. WebSocket / Server-Sent Events：与 HTTP 不同的连接模型，有自己的跨源策略（通常由服务器决定）.

### 预检（Preflight）
- 复杂请求会先发 OPTIONS 请求，服务器需返回允许的方法、头以及允许来源。
- 常见问题：浏览器控制台显示 401/403/404 或缺少 Access-Control-Allow-*。

### 带凭证请求（Cookies / Authorization）
- 前端需设置 fetch/axios withCredentials: true 或 fetch 的 credentials: 'include'。
- 服务器需返回 Access-Control-Allow-Credentials: true，且 Access-Control-Allow-Origin 不能为 '*'。

### 安全与实践建议
- 仅允许受信任的域名，避免使用 Access-Control-Allow-Origin: * 配合凭证。
- 尽量在服务器端做鉴权与速率限制，代理比客户端绕过更安全可控。
- 检查浏览器控制台和网络面板的预检与响应头定位问题。

小结：优先用 CORS + 合理服务端配置；不支持时用代理或 window.postMessage 等替代方案，根据场景权衡安全与兼容。