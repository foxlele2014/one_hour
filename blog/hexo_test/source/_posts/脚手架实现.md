---
title: 脚手架实现
date: 2018-02-07 17:01:57
tags:
- 脚手架
category:
- javascript
---

### 概览
脚手架（scaffold / scaffolding）是用来快速生成项目骨架、约定文件和初始配置的工具。常见目标：生成目录结构、模板文件、默认配置、安装依赖、初始化版本控制等，帮助团队保持一致性并提升开发效率。

### 实现原理（核心要素）
- 模板引擎：用 ejs / handlebars / mustache 等渲染模板文件，替换占位符。
- 交互与配置：用 inquirer / prompts 获取用户输入（项目名、license、包管理器等）。
- 文件操作：复制/渲染模板到目标目录（fs-extra、globby）。
- 依赖安装：可选择自动执行 npm/yarn/pnpm install（child_process.exec）。
- 初始化 VCS：可选 git init、commit。
- 扩展与插件：提供 hooks 或插件接口，支持后续扩展（如生成 CI、Dockerfile）。
- 幂等与安全：检测目标路径是否为空或冲突，提供覆盖/跳过策略。

### 常见脚手架工具简介
- Hexo
  - 主要是静态博客框架，包含 scaffold 概念（source/_posts/scaffolds），`hexo new` 使用 scaffold 生成带 front-matter 的文章/页面模板。
  - 使用场景：博客内容模板化（post、page、draft），主题/插件生态。
- Metalsmith
  - 轻量文件管道静态站点生成器，通过插件链处理文件（读取 -> transform -> write）。
  - 可用于构建自定义脚手架或作为生成步骤的一部分。
- Yeoman
  - 流行的项目脚手架生态，基于 generator（npm 包）定义交互、文件模板和写入步骤。
  - 特点：强交互、蓝图式生成、社区 generator 丰富（React/Angular/Vue 等）。
  - 常用命令：yo <generator>，发布为 npm 包，使用 yeoman-generator API 处理 prompts、写入、安装依赖。

### 简单实现示例（最小 CLI 脚手架）
示例功能：询问项目名，复制模板并渲染 package.json，选择是否安装依赖。
```javascript
#!/usr/bin/env node
const path = require('path');
const fs = require('fs-extra');
const inquirer = require('inquirer');
const ejs = require('ejs');
const { execSync } = require('child_process');

async function run() {
  const { name, install } = await inquirer.prompt([
    { name: 'name', message: 'Project name', default: 'my-app' },
    { name: 'install', type: 'confirm', message: 'Install dependencies?', default: true }
  ]);
  const target = path.resolve(process.cwd(), name);
  if (await fs.pathExists(target)) {
    console.error('Target exists. Aborting.');
    process.exit(1);
  }
  await fs.copy(path.join(__dirname, 'templates'), target);
  const pkgTpl = await fs.readFile(path.join(target, 'package.json.ejs'), 'utf8');
  await fs.writeFile(path.join(target, 'package.json'), ejs.render(pkgTpl, { name }));
  if (install) {
    execSync('npm install', { cwd: target, stdio: 'inherit' });
  }
  console.log('Scaffold created at', target);
}
run();
```
说明：模板文件可放 templates/ 下，使用 package.json.ejs 等占位渲染。

### Yeoman generator 最小骨架
- 目录结构：generator-my/generators/app/index.js、templates/**
- index.js 使用 this.prompt、this.fs.copyTpl、this.npmInstall 等 API。

示例（核心片段）：
```javascript
const Generator = require('yeoman-generator');
module.exports = class extends Generator {
  async prompting() {
    this.answers = await this.prompt([{ name: 'name', message: 'Project name' }]);
  }
  writing() {
    this.fs.copyTpl(
      this.templatePath('**/*'),
      this.destinationPath(this.answers.name),
      this.answers
    );
  }
  install() {
    this.npmInstall([], {}, { cwd: this.destinationPath(this.answers.name) });
  }
};
```

### Hexo scaffold 快速说明
- 把模板放在主题或站点的 scaffolds 目录（如 scaffolds/post），内容为 front-matter 模板。
- 使用：hexo new "title" 会基于 scaffolds/post 生成文章文件。

### 注意点与最佳实践
- 可配置性：提供选项（语言、框架、样式、测试），避免硬编码。
- 可复现性：生成后记录依赖版本、提供 lock 文件。
- 幂等与安全：遇文件冲突提供交互或 --force 选项，避免无意覆盖。
- 模块化模板：拆分可复用片段（LICENSE、CI、Dockerfile）。
- 测试：为 generator 添加集成测试（如 Yeoman Test，或用临时目录断言文件生成）。
- 发布与文档：把 CLI 做为 bin 导出，文档写清使用示例与选项，发布到 npm。
- 性能：避免在模板中执行大量同步阻塞操作，异步 IO 更友好。
- 安全：慎用模板中的任意代码执行，避免注入风险。

小结：脚手架的核心是「交互+模板+文件写入+可选安装/初始化」，工具层面可选 Yeoman、自己用 Node 实现、或结合静态站生成器（Hexo/Metalsmith）完成更复杂的流水线。根据项目复杂度选择更成熟的生态（Yeoman）或轻量可控的自实现方案。
